name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest

    env:
      DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
      EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
      EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
      POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
      REDIS_PORT: 6380
      CELERY_BROKER_URL: redis://redis:6380/0
      CELERY_RESULT_BACKEND: redis://redis:6380/0
      DJANGO_PORT: 8010
      ALLOWED_HOSTS: ecommerce.igwilo.com,www.ecommerce.igwilo.com
      CORS_ALLOWED_ORIGINS: https://igwilo.com,https://www.igwilo.com,https://ecommerce.igwilo.com,ecommerce.igwilo.com

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ecommerce/requirements.txt

      - name: Run Linting
        run: |
          pip install flake8
          flake8 apps/ ecommerce/ --max-line-length=120 --exclude=migrations,__pycache__ --ignore=E501,W503

      - name: Run Tests
        run: |
          pip install pytest pytest-django
          python manage.py test apps/ --verbosity=2
        env:
          DJANGO_SETTINGS_MODULE: ecommerce.settings
          NAME: ${{ env.POSTGRES_DB }}
          USER: ${{ env.POSTGRES_USER }}
          PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          HOST: ${{ env.POSTGRES_HOST }}
          PORT: ${{ env.POSTGRES_PORT }}

      - name: Copy Project Files to Server
        uses: appleboy/scp-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ".,!.git,!.github,!__pycache__,!*.pyc,!.env"
          target: ~/ecommerce
          strip_components: 0
          overwrite: true

      - name: Ensure Directories and Create .env File
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Ensure static and media directories exist
            mkdir -p /home/devops/ecommerce/staticfiles
            mkdir -p /home/devops/ecommerce/media

            # Create .env file
            cat > ~/ecommerce/.env <<EOF
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DEBUG=False
            ALLOWED_HOSTS=ecommerce.igwilo.com,www.ecommerce.igwilo.com
            DJANGO_PORT=8010
            REDIS_PORT=6380
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=ecommerce_db
            POSTGRES_HOST=db
            CELERY_BROKER_URL=redis://redis:6380/0
            CELERY_RESULT_BACKEND=redis://redis:6380/0
            EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
            EMAIL_HOST=${{ secrets.EMAIL_HOST }}
            EMAIL_PORT=587
            EMAIL_USE_TLS=True
            EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
            EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
            DEFAULT_FROM_EMAIL=noreply@igwilo.com
            EOF

            # Secure the .env file
            chmod 600 ~/ecommerce/.env

      - name: Deploy Services with Docker Compose
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/ecommerce
            # Stop existing containers
            docker-compose down
            # Build the image on the server and start services
            docker-compose build --no-cache
            docker-compose up -d
            # Clean up unused images to save disk space
            docker image prune -f
